import asyncio
import os
import sys
import logging
from app.core.database import AsyncSessionLocal, engine
from app.models.base import Base
from legacy.services.shop_service import shop_service
from legacy.models.gamification import Item, UserItem
from app.models.user import User

# Logging
logging.basicConfig(level=logging.INFO, format="%(message)s")
logger = logging.getLogger("Exploit")

os.environ["TESTING"] = "1"


async def setup_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)


async def seed_data():
    async with AsyncSessionLocal() as session:
        # Cleanup
        existing = await session.get(User, "attacker")
        if existing:
            await session.delete(existing)

        # Cleanup Item
        existing_item = await session.get(Item, 1)
        if existing_item:
            await session.delete(existing_item)

        await session.commit()

        # Create User with 100 Gold
        u = User(id="attacker", name="Hacker", gold=100)
        session.add(u)

        # Create Item costing 100 Gold
        i = Item(id=1, name="Golden Apple", price=100, is_purchasable=True)
        session.add(i)

        await session.commit()
        logger.info("[Setup] User Gold: 100, Item Price: 100")


async def attack():
    logger.info("[Attack] Launching 20 Concurrent Buy Requests...")

    tasks = []
    for i in range(20):
        tasks.append(buy_attempt(i))

    results = await asyncio.gather(*tasks, return_exceptions=True)

    success_count = 0
    for r in results:
        if isinstance(r, dict) and r.get("success"):
            success_count += 1

    logger.info(f"[Result] Successful Transactions: {success_count}")
    return success_count


async def buy_attempt(idx):
    async with AsyncSessionLocal() as session:
        # User ID "attacker", Item ID 1
        # We need to ensure we don't accidentally reuse session across tasks?
        # AsyncSessionLocal() creates fresh session.
        return await shop_service.buy_item(session, "attacker", 1)


async def verify_outcome():
    async with AsyncSessionLocal() as session:
        from sqlalchemy import select

        # Check User Gold
        u = await session.get(User, "attacker")
        # Check Inventory
        result = await session.execute(select(UserItem).where(UserItem.user_id == "attacker"))
        items = result.scalars().all()
        qty = sum([i.quantity for i in items])

        logger.info(f"[Audit] Final User Gold: {u.gold}")
        logger.info(f"[Audit] Final Inventory Qty: {qty}")

        if qty > 1:
            logger.info(f"üö® EXPLOIT SUCCESS: Bought {qty} items for price of 1! (Double Spend)")
        elif qty == 1 and u.gold == 0:
            logger.info("‚úÖ Defense Successful: Bought 1, Gold 0.")
        else:
            logger.info(f"‚ùì Inconclusive: {qty} items, {u.gold} gold.")


async def main():
    await setup_db()
    await seed_data()
    await attack()
    await verify_outcome()


if __name__ == "__main__":
    asyncio.run(main())
