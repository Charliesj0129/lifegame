name: deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
      AZURE_ACR_NAME: ${{ secrets.AZURE_ACR_NAME }}
      IMAGE_NAME: lifgame
      APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
      LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install alembic
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Pre-deploy checks
        run: scripts/pre_deploy_checks.sh
      - name: Build and push container
        run: |
          IMAGE_TAG="${GITHUB_SHA}"
          az acr build --registry "${AZURE_ACR_NAME}" --image "${IMAGE_NAME}:${IMAGE_TAG}" .
      - name: Update Web App image
        run: |
          IMAGE_TAG="${GITHUB_SHA}"
          az webapp config container set \
            --name "${AZURE_WEBAPP_NAME}" \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --docker-custom-image-name "${AZURE_ACR_NAME}.azurecr.io/${IMAGE_NAME}:${IMAGE_TAG}" \
            --docker-registry-server-url "https://${AZURE_ACR_NAME}.azurecr.io"
          az webapp restart --name "${AZURE_WEBAPP_NAME}" --resource-group "${AZURE_RESOURCE_GROUP}"
      - name: Post-deploy smoke
        run: scripts/post_deploy_smoke.sh
